# 大数据生成脚本

## 说明

此脚本用于生成大量接近真实的测试数据，用于性能测试和压力测试。

## 生成的数据量

- **用户**: 150 个
- **分类**: 树形结构
  - **大类**: 6 个（金融💰、科技💻、游戏🎮、体育⚽、政治🏛️、生活🎨）
  - **子分类**: 约 30 个（每个大类下 3-8 个子分类）
- **标签**: 约 80+ 个（已关联到对应分类）
- **文章**: 1000 篇（约 800 篇已发布）
- **评论**: 每篇文章 0-10 条（总计约 5000+ 条）
- **点赞**: 文章和评论的点赞（总计约 50000+ 个）
- **收藏**: 文章的收藏（总计约 20000+ 个）
- **关注关系**: 用户之间的关注（总计约 3000+ 个）

## 使用方法

### 1. 确保数据库已创建并配置

确保 `.env` 文件中的数据库配置正确：

```env
DB_HOST=localhost
DB_PORT=5432
DB_USERNAME=postgres
DB_PASSWORD=postgres
DB_DATABASE=fidoo_blog
```

### 2. 运行大数据生成脚本

```bash
# 在 service 目录下
pnpm seed:large
```

或者使用 npm：

```bash
npm run seed:large
```

## 注意事项

⚠️ **警告**:

1. **此脚本会生成大量数据**，可能需要较长时间（约 5-10 分钟）
2. **建议在测试环境使用**，不要在生产环境运行
3. **会清空现有数据**（如果需要保留现有数据，请先备份数据库）
4. **确保数据库有足够的空间**（建议至少 500MB 可用空间）

## 数据特点

### 用户数据

- 包含中文和英文用户名
- 随机生成头像（使用 DiceBear API）
- 随机分配城市和公司
- 包含管理员、编辑和普通用户

### 分类数据（树形结构）

- **大类（level=0）**: 6 个大类，每个大类有图标
  - 金融 💰: 股票投资、基金理财、数字货币、保险、银行
  - 科技 💻: 前端开发、后端开发、移动开发、人工智能、开发工具、数据库、DevOps、架构设计
  - 游戏 🎮: 游戏评测、游戏开发、电竞、游戏攻略
  - 体育 ⚽: 足球、篮球、健身、跑步
  - 政治 🏛️: 时政、国际、社会
  - 生活 🎨: 美食、旅行、摄影、阅读、电影
- **子分类（level=1）**: 每个大类下 3-8 个子分类

### 标签数据

- 标签已关联到对应的分类（categoryId）
- 技术类标签关联到科技类的子分类
- 其他分类有相应的主题标签
- 包含一些未分类的通用标签（热门、推荐、精华）

### 文章数据

- 文章标题基于模板生成，包含技术关键词
- 文章内容使用 Markdown 格式
- 优先分配到子分类，标签优先选择与分类相关的标签
- 每篇文章 2-5 个标签
- 发布时间分布在过去一年内
- 包含浏览量、点赞数、评论数等统计数据

### 关系数据

- 点赞：文章和评论都有点赞数据
- 收藏：部分文章有收藏数据
- 关注：用户之间有随机的关注关系
- 评论：每篇文章有 0-10 条评论

## 性能优化

脚本使用了以下优化策略：

1. **批量保存**: 使用批量保存（每批 50 条）减少数据库操作
2. **关闭日志**: 生成数据时关闭 TypeORM 日志以提高性能
3. **分批处理**: 大数据量分批处理，避免内存溢出

## 自定义数据量

如果需要修改生成的数据量，可以编辑 `generate-large-data.ts` 文件中的以下常量：

```typescript
// 修改用户数量
for (let i = 0; i < 150; i++) { // 改为你想要的数字

// 修改文章数量
for (let i = 0; i < 1000; i++) { // 改为你想要的数字

// 修改批量大小
const batchSize = 50; // 根据数据库性能调整
```

## 清理数据

如果需要清理生成的数据，可以：

1. 直接删除数据库并重新创建
2. 使用数据库管理工具手动删除
3. 修改脚本添加清理逻辑

## 故障排除

### 内存不足

如果遇到内存不足错误，可以：

- 减小批量大小（`batchSize`）
- 减少生成的数据量
- 增加 Node.js 内存限制：`NODE_OPTIONS=--max-old-space-size=4096 pnpm seed:large`

### 数据库连接超时

如果遇到连接超时：

- 检查数据库配置
- 增加数据库连接池大小
- 检查网络连接

### 外键约束错误

如果遇到外键约束错误：

- 确保所有实体都已正确创建
- 检查数据生成顺序
- 确保关联关系正确

## 后续优化建议

1. **索引优化**: 确保数据库表有适当的索引
2. **查询优化**: 使用分页查询，避免一次性加载大量数据
3. **缓存策略**: 对热点数据进行缓存
4. **数据库优化**: 根据实际使用情况调整数据库配置
