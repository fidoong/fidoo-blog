# 后台管理 Dockerfile
FROM node:lts-alpine AS base

# 安装 pnpm
RUN npm install -g pnpm@10.20.0

# 设置工作目录
WORKDIR /app

# 复制 package 文件
COPY package.json pnpm-workspace.yaml ./
COPY pnpm-lock.yaml* ./
COPY packages/shared/package.json ./packages/shared/
COPY admin/package.json ./admin/

# 安装依赖（如果有 lock 文件使用 frozen，否则正常安装）
RUN if [ -f pnpm-lock.yaml ]; then pnpm install --frozen-lockfile; else pnpm install; fi

# 复制源代码
COPY packages/shared ./packages/shared
COPY admin ./admin

# 构建阶段
FROM base AS builder

# 构建共享包
RUN pnpm --filter @fidoo-blog/shared build

# 设置构建环境变量
ENV NODE_ENV=production
ENV NEXT_TELEMETRY_DISABLED=1

# 构建 Next.js 应用
RUN pnpm --filter @fidoo-blog/admin build

# 生产阶段
FROM node:lts-alpine AS production

WORKDIR /app

# 安装 pnpm
RUN npm install -g pnpm@10.20.0

# 复制 package 文件
COPY package.json pnpm-lock.yaml pnpm-workspace.yaml ./
COPY packages/shared/package.json ./packages/shared/
COPY admin/package.json ./admin/

# 只安装生产依赖
RUN pnpm install --frozen-lockfile --prod

# 从构建阶段复制构建产物
COPY --from=builder /app/packages/shared/dist ./packages/shared/dist
COPY --from=builder /app/admin/.next/standalone ./
COPY --from=builder /app/admin/.next/static ./admin/.next/static
COPY --from=builder /app/admin/public ./admin/public

# 设置环境变量
ENV NODE_ENV=production
ENV PORT=3001
ENV NEXT_TELEMETRY_DISABLED=1

# 暴露端口
EXPOSE 3001

# 启动服务
WORKDIR /app/admin
CMD ["node", "server.js"]

